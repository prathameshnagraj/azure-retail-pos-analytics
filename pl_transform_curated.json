{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"factoryName":{"type":"string","metadata":"Data Factory name"},"ls_adls_conagra":{"type":"string"}},"variables":{"factoryId":"[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"},"resources":[{"name":"[concat(parameters('factoryName'), '/pl_transform_curated')]","type":"Microsoft.DataFactory/factories/pipelines","apiVersion":"2018-06-01","properties":{"activities":[{"name":"ForEachYear","type":"ForEach","dependsOn":[],"userProperties":[],"typeProperties":{"items":{"value":"@createArray('2020','2021','2022','2023','2024')","type":"Expression"},"isSequential":true,"activities":[{"name":"df_refine_poultry_data","type":"ExecuteDataFlow","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"dataflow":{"referenceName":"df_refine_poultry_data","type":"DataFlowReference","parameters":{},"datasetParameters":{"POS":{"p_folder_path":"poultry-pos-csv","p_file_name":{"value":"@concat('year=', item())","type":"Expression"}},"Attributes":{},"snkcurated":{"p_year":{"value":"@item()","type":"Expression"}}}},"staging":{},"compute":{"coreCount":8,"computeType":"General"},"traceLevel":"Fine"}}]}}],"policy":{"elapsedTimeMetric":{}},"annotations":[],"lastPublishTime":"2026-01-14T14:41:41Z"},"dependsOn":["[concat(variables('factoryId'), '/dataflows/df_refine_poultry_data')]"]},{"name":"[concat(parameters('factoryName'), '/df_refine_poultry_data')]","type":"Microsoft.DataFactory/factories/dataflows","apiVersion":"2018-06-01","properties":{"type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"ds_csv_pos_bronze","type":"DatasetReference"},"name":"POS"},{"dataset":{"referenceName":"ds_csv_attributes_bronze","type":"DatasetReference"},"name":"Attributes"}],"sinks":[{"dataset":{"referenceName":"ds_parquet_pos_curated","type":"DatasetReference"},"name":"snkcurated"}],"transformations":[{"name":"selposrename"},{"name":"drvpos"},{"name":"drvpos2"},{"name":"castpos"},{"name":"selattr"},{"name":"drvattr"},{"name":"posupcrename"},{"name":"attrupcrename"},{"name":"posjoinattr"},{"name":"selcuratedschema"}],"scriptLines":["parameters{","     p_year as string ('2024')","}","source(output(","          Geography as string,","          Time as string,","          Product as string,","          {UPC 13 digit} as long,","          {Unit Sales} as double,","          {Volume Sales} as double,","          {Dollar Sales} as double,","          {Price per Unit} as double,","          {Price per Volume} as double,","          {Base Unit Sales} as double,","          {Base Volume Sales} as double,","          {Base Dollar Sales} as double,","          {Incremental Units} as double,","          {Incremental Volume} as double,","          {Incremental Dollars} as double,","          {ACV Weighted Distribution} as double","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> POS","source(output(","          Product as string,","          {UPC 13 digit} as long,","          {Aisle Name} as string,","          {Category Name} as string,","          {Sub-Category Name} as string,","          {Manufacturer Name} as string,","          {Brand Franchise Name} as string,","          {Brand Name} as string,","          Package as string,","          {Total Count} as short,","          {Total Ounces} as double,","          Form as string,","          {Flavor / Scent} as string,","          {Meat Source} as string,","          {Product Type} as string,","          {Type Of Meat Substituted} as string,","          {Type Of Substitute} as string,","          {Cooked Info} as string","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> Attributes","POS select(mapColumn(","          geography = Geography,","          week_ending_raw = Time,","          product = Product,","          upc_raw = {UPC 13 digit},","          unit_sales_raw = {Unit Sales},","          volume_sales = {Volume Sales},","          dollar_sales_raw = {Dollar Sales},","          price_per_unit = {Price per Unit},","          price_per_volume = {Price per Volume},","          base_unit_sales = {Base Unit Sales},","          base_volume_sales = {Base Volume Sales},","          base_dollar_sales = {Base Dollar Sales},","          incremental_units = {Incremental Units},","          incremental_volume = {Incremental Volume},","          incremental_dollars = {Incremental Dollars},","          acv_weighted_distribution = {ACV Weighted Distribution}","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> selposrename","selposrename derive(upc_raw = lpad(toString(upc_raw), 13, '0'),","          week_ending_clean = trim(replace(week_ending_raw, 'Week Ending', ''))) ~> drvpos","drvpos derive(week_ending_date = toDate(week_ending_clean, 'MM-dd-yy')) ~> drvpos2","drvpos2 cast(output(","          geography as string,","          week_ending_raw as string,","          product as string,","          upc_raw as string,","          unit_sales_raw as double,","          volume_sales as double,","          dollar_sales_raw as double,","          price_per_unit as double,","          price_per_volume as double,","          base_unit_sales as double,","          base_volume_sales as double,","          base_dollar_sales as double,","          incremental_units as double,","          incremental_volume as double,","          incremental_dollars as double,","          acv_weighted_distribution as double,","          week_ending_clean as string,","          week_ending_date as date","     ),","     errors: true) ~> castpos","Attributes select(mapColumn(","          product = Product,","          upc_raw = {UPC 13 digit},","          aisle_name = {Aisle Name},","          category_name = {Category Name},","          subcategory_name = {Sub-Category Name},","          manufacturer_name = {Manufacturer Name},","          brand_franchise_name = {Brand Franchise Name},","          brand_name = {Brand Name},","          package = Package,","          total_count = {Total Count},","          total_ounces = {Total Ounces},","          form = Form,","          flavor_scent = {Flavor / Scent},","          meat_source = {Meat Source},","          product_type = {Product Type},","          type_of_meat_substituted = {Type Of Meat Substituted},","          type_of_substitute = {Type Of Substitute},","          cooked_info = {Cooked Info}","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> selattr","selattr derive(upc_raw = lpad(toString(upc_raw), 13, '0')) ~> drvattr","castpos select(mapColumn(","          geography,","          week_ending_raw,","          product,","          upc_pos = upc_raw,","          unit_sales_raw,","          volume_sales,","          dollar_sales_raw,","          price_per_unit,","          price_per_volume,","          base_unit_sales,","          base_volume_sales,","          base_dollar_sales,","          incremental_units,","          incremental_volume,","          incremental_dollars,","          acv_weighted_distribution,","          week_ending_clean,","          week_ending_date","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> posupcrename","drvattr select(mapColumn(","          product,","          upc_attr = upc_raw,","          aisle_name,","          category_name,","          subcategory_name,","          manufacturer_name,","          brand_franchise_name,","          brand_name,","          package,","          total_count,","          total_ounces,","          form,","          flavor_scent,","          meat_source,","          product_type,","          type_of_meat_substituted,","          type_of_substitute,","          cooked_info","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> attrupcrename","posupcrename, attrupcrename join(upc_pos == upc_attr,","     joinType:'left',","     matchType:'exact',","     ignoreSpaces: false,","     broadcast: 'auto')~> posjoinattr","posjoinattr select(mapColumn(","          geography,","          week_ending_raw,","          product = posupcrename@product,","          upc_pos,","          unit_sales_raw,","          volume_sales,","          dollar_sales_raw,","          price_per_unit,","          price_per_volume,","          base_unit_sales,","          base_volume_sales,","          base_dollar_sales,","          incremental_units,","          incremental_volume,","          incremental_dollars,","          acv_weighted_distribution,","          week_ending_clean,","          week_ending_date,","          product = attrupcrename@product,","          upc_attr,","          aisle_name,","          category_name,","          subcategory_name,","          manufacturer_name,","          brand_franchise_name,","          brand_name,","          package,","          total_count,","          total_ounces,","          form,","          flavor_scent,","          meat_source,","          product_type,","          type_of_meat_substituted,","          type_of_substitute,","          cooked_info","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> selcuratedschema","selcuratedschema sink(allowSchemaDrift: true,","     validateSchema: false,","     format: 'parquet',","     umask: 0022,","     preCommands: [],","     postCommands: [],","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> snkcurated"]}},"dependsOn":["[concat(variables('factoryId'), '/datasets/ds_csv_pos_bronze')]","[concat(variables('factoryId'), '/datasets/ds_csv_attributes_bronze')]","[concat(variables('factoryId'), '/datasets/ds_parquet_pos_curated')]"]},{"name":"[concat(parameters('factoryName'), '/ds_csv_pos_bronze')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_adls_conagra')]","type":"LinkedServiceReference"},"parameters":{"p_folder_path":{"type":"string","defaultValue":"poultry-pos-csv"},"p_file_name":{"type":"string","defaultValue":"year=2020"}},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobFSLocation","fileName":{"value":"@dataset().p_file_name","type":"Expression"},"folderPath":{"value":"@dataset().p_folder_path","type":"Expression"},"fileSystem":"bronze"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_csv_attributes_bronze')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_adls_conagra')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobFSLocation","fileName":"product_attributes.csv","folderPath":"product-master","fileSystem":"bronze"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_parquet_pos_curated')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_adls_conagra')]","type":"LinkedServiceReference"},"parameters":{"p_year":{"type":"string"}},"annotations":[],"type":"Parquet","typeProperties":{"location":{"type":"AzureBlobFSLocation","fileName":{"value":"year=@{dataset().p_year}","type":"Expression"},"folderPath":"poultry_pos_enriched","fileSystem":"curated"},"compressionCodec":"snappy"},"schema":[]},"dependsOn":[]}]}